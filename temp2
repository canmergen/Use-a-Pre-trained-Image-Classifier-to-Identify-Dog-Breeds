def prune_sig_boxes_by_nt_coverage(
    sig_boxes,
    nt_boxes,
    cover_threshold=0.4
):
    """
    nt kutularının %X'inden fazlasını kapsayan signature kutularını siler.
    """
    from collections import defaultdict

    #--- Yardımcı fonksiyonlar ---
    def area(b):
        x1, y1, x2, y2 = b
        return max(0, x2 - x1) * max(0, y2 - y1)

    def intersection(a, b):
        ax1, ay1, ax2, ay2 = a
        bx1, by1, bx2, by2 = b
        x1 = max(ax1, bx1)
        y1 = max(ay1, by1)
        x2 = min(ax2, bx2)
        y2 = min(ay2, by2)
        if x2 <= x1 or y2 <= y1:
            return 0
        return (x2 - x1) * (y2 - y1)

    #--- NT kutularını sayfa bazında grupla ---
    nt_map = defaultdict(list)
    for page in nt_boxes:
        idx = page["image_index"]
        for b in page.get("boxes", []):
            xyxy = b.get("xyxy")
            if xyxy and len(xyxy) == 4:
                nt_map[idx].append(xyxy)

    #--- Şimdi signature kutularını prune et ---
    pruned = []
    for page in sig_boxes:
        idx = page["image_index"]
        page_nt_boxes = nt_map.get(idx, [])

        if not page_nt_boxes:
            pruned.append(page)
            continue

        kept = []
        for b in page.get("boxes", []):
            sb = b.get("xyxy")
            if not sb or len(sb) != 4:
                continue

            s_area = area(sb)
            remove = False

            for nt in page_nt_boxes:
                nt_area = area(nt)
                inter = intersection(sb, nt)

                # signature'ın NT kutusunu kapsama oranı
                cover_nt = inter / nt_area if nt_area > 0 else 0

                if cover_nt >= cover_threshold:
                    remove = True
                    break

            if not remove:
                kept.append(b)

        new_page = dict(page)
        new_page["boxes"] = kept
        pruned.append(new_page)

    return pruned

sig_boxes = prune_sig_boxes_by_nt_coverage(
    sig_boxes,
    nt_boxes,
    cover_threshold=0.40
)

visualize_filtered_boxes(sig_boxes, lower_imgs_binarized)