import cv2
import numpy as np
import pandas as pd


def _detect_table_on_page(
    img: np.ndarray,
    min_h_lines: int = 1,
    min_v_lines: int = 1,
    min_intersections: int = 1,
    min_area_ratio: float = 0.02,
    debug: bool = False
) -> bool:
    """
    Tek bir sayfada tablo var mı yok mu döner (True/False).

    Sadece dikdörtgen görüp tablo dememek için:
      - Yatay çizgi sayısı
      - Dikey çizgi sayısı
      - Çizgi kesişim sayısı
      - Tablo bbox alan oranı
    filtreleri kullanılır.
    """

    # 1) Gri + binary
    if img.ndim == 3:
        gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    else:
        gray = img.copy()

    # OTSU + invert
    _, bw = cv2.threshold(gray, 0, 255, cv2.THRESH_BINARY_INV + cv2.THRESH_OTSU)

    h, w = bw.shape

    # 2) Yatay ve dikey çizgi maskeleri
    # kernel boyutları sayfa boyutuna göre
    horizontal_size = max(20, w // 60)
    vertical_size = max(20, h // 40)

    horiz_kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (horizontal_size, 1))
    vert_kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (1, vertical_size))

    # Yatay çizgiler
    horizontal_lines = cv2.erode(bw, horiz_kernel, iterations=1)
    horizontal_lines = cv2.dilate(horizontal_lines, horiz_kernel, iterations=1)

    # Dikey çizgiler
    vertical_lines = cv2.erode(bw, vert_kernel, iterations=1)
    vertical_lines = cv2.dilate(vertical_lines, vert_kernel, iterations=1)

    # 3) Çizgi sayısını tahmin et
    cnts_h, _ = cv2.findContours(horizontal_lines, cv2.RETR_LIST, cv2.CHAIN_APPROX_SIMPLE)
    cnts_v, _ = cv2.findContours(vertical_lines, cv2.RETR_LIST, cv2.CHAIN_APPROX_SIMPLE)

    num_h = len(cnts_h)
    num_v = len(cnts_v)

    # 4) Yatay & dikey çizgi kesişimlerini bul
    intersections = cv2.bitwise_and(horizontal_lines, vertical_lines)
    cnts_i, _ = cv2.findContours(intersections, cv2.RETR_LIST, cv2.CHAIN_APPROX_SIMPLE)
    num_i = len(cnts_i)

    # 5) Yatay + dikey maskeleri birleştir, en büyük contour'u al
    table_mask = cv2.bitwise_or(horizontal_lines, vertical_lines)
    cnts_t, _ = cv2.findContours(table_mask, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

    if not cnts_t:
        if debug:
            print("[DEBUG] no table-like contour found")
        return False

    max_cnt = max(cnts_t, key=cv2.contourArea)
    x, y, w_box, h_box = cv2.boundingRect(max_cnt)
    area_ratio = (w_box * h_box) / float(w * h)

    if debug:
        print(
            f"[DEBUG] h_lines={num_h}, v_lines={num_v}, "
            f"intersections={num_i}, area_ratio={area_ratio:.3f}"
        )

    # 6) Eşik kontrolleri
    if num_h < min_h_lines:
        if debug:
            print("[DEBUG] failed: not enough horizontal lines")
        return False

    if num_v < min_v_lines:
        if debug:
            print("[DEBUG] failed: not enough vertical lines")
        return False

    if num_i < min_intersections:
        if debug:
            print("[DEBUG] failed: not enough intersections")
        return False

    if area_ratio < min_area_ratio:
        if debug:
            print("[DEBUG] failed: table area too small")
        return False

    if debug:
        print("[DEBUG] table detected")

    return True


def build_table_control_df(doc_images, debug: bool = False):
    """
    doc_images: her elemanı bir sayfa görüntüsü (np.ndarray) olan liste.
    Dönen: page_index ve tablo_var_mi (1/0) içeren DataFrame.
    """
    rows = []
    for page_index, img in enumerate(doc_images):
        has_table = _detect_table_on_page(img, debug=debug)
        rows.append({
            "page_index": page_index,
            "tablo_var_mi": 1 if has_table else 0
        })

    table_control_df = pd.DataFrame(rows)
    return table_control_df

table_control_df = build_table_control_df(doc_images, debug=True)
display(table_control_df)