from difflib import SequenceMatcher
from typing import List, Dict, Any
import numpy as np


def mark_signatures_on_imza_column(
    table_dfs: List["pd.DataFrame"],
    page_cells_all: List[List[Dict[str, Any]]],
    sig_boxes: List[Dict[str, Any]],
    signature_header_target: str = "IMZA",   # veya "İMZA"
    fuzzy_min_score: float = 0.7,
    max_vertical_factor: float = 1.0,        # ister 0.75'e tekrar çekebilirsin
):
    """
    table_dfs      : list[pd.DataFrame] -> her sayfanın tablo DataFrame'i
    page_cells_all : list[list[dict]]   -> her sayfa için hücreler (row, col, x, y, w, h)
    sig_boxes      : YOLO imza çıkışları (predict_on_memory_images -> all_boxes listesi)

    Mantık:
    - Her sayfada imza kolonundaki hücreleri yukarıdan aşağıya sırala.
    - Aynı sayfadaki imza bbox'larını dikey merkezine göre sırala.
    - Sırayla eşleştir: k. imza -> k. hücre.
    """

    # 1) YOLO çıktısını normalize et: (image_index, x_min, y_min, x_max, y_max)
    norm_sigs: List[Dict[str, Any]] = []

    for sb in sig_boxes:
        img_idx = sb.get("image_index", 0)
        boxes = sb.get("boxes", [])

        for b in boxes:
            # b: {"xyxy":[x1,y1,x2,y2], ...} vb.
            xyxy = (
                b.get("xyxy")
                or b.get("bbox")
                or b.get("xxyy")
                or b
            )
            if xyxy is None or len(xyxy) != 4:
                continue

            x1, y1, x2, y2 = map(float, xyxy)

            norm_sigs.append(
                {
                    "image_index": int(img_idx),
                    "x_min": x1,
                    "y_min": y1,
                    "x_max": x2,
                    "y_max": y2,
                }
            )

    # 2) Kolon adını fuzzy ile bul
    def fuzzy_best_col(columns, target: str):
        best_col = None
        best_score = 0.0
        t = target.upper()

        for col in columns:
            s = SequenceMatcher(None, str(col).upper(), t).ratio()
            if s > best_score:
                best_score = s
                best_col = col
        return best_col, best_score

    # 3) Her sayfa için imza kolonunu 0/1 olarak doldur
    result_dfs: List["pd.DataFrame"] = []

    for page_index, df in enumerate(table_dfs):
        if df is None or df.empty:
            result_dfs.append(df)
            continue

        # "page_index" hariç kolonlar
        data_cols = [c for c in df.columns if c != "page_index"]

        sig_col_name, score = fuzzy_best_col(data_cols, signature_header_target)

        # imza başlığı yoksa dokunma
        if sig_col_name is None or score < fuzzy_min_score:
            result_dfs.append(df)
            continue

        sig_col_pos = data_cols.index(sig_col_name)

        # İMZA kolonunu 0 ile başlat
        df[sig_col_name] = 0

        # Sayfanın hücreleri ve imzaları
        cells = page_cells_all[page_index]
        page_sigs = [s for s in norm_sigs if s["image_index"] == page_index]

        if not cells or not page_sigs:
            result_dfs.append(df)
            continue

        # Sadece imza kolonundaki hücreler
        imza_cells = [c for c in cells if c["col"] == sig_col_pos]
        if not imza_cells:
            result_dfs.append(df)
            continue

        # 3.1 Hücreleri yukarıdan aşağıya sırala (center_y)
        for c in imza_cells:
            c["_center_y"] = float(c["y"]) + 0.5 * float(c["h"])
        imza_cells_sorted = sorted(imza_cells, key=lambda c: c["_center_y"])

        # 3.2 İmzaları yukarıdan aşağıya sırala (center_y)
        for s in page_sigs:
            s["_center_y"] = 0.5 * (s["y_min"] + s["y_max"])
        page_sigs_sorted = sorted(page_sigs, key=lambda s: s["_center_y"])

        # 3.3 Kaç imza varsa o kadar satıra 1 ver
        n_pairs = min(len(imza_cells_sorted), len(page_sigs_sorted))

        for k in range(n_pairs):
            cell = imza_cells_sorted[k]
            sig = page_sigs_sorted[k]

            cy = cell["_center_y"]
            sy = sig["_center_y"]
            ch = float(cell["h"])

            # Güvenlik: dikey uzaklık çok absürt olmasın
            if abs(sy - cy) > max_vertical_factor * ch:
                # çok uzaktaysa bu eşlemeyi atla
                continue

            row_idx = cell["row"]
            if row_idx in df.index:
                df.at[row_idx, sig_col_name] = 1

        # temizlik
        for c in imza_cells:
            c.pop("_center_y", None)
        for s in page_sigs:
            s.pop("_center_y", None)

        result_dfs.append(df)

    return result_dfs

table_dfs_marked = mark_signatures_on_imza_column(
    table_dfs=table_df,
    page_cells_all=page_cells_all,
    sig_boxes=sig_boxes,
    signature_header_target="İMZA",
    fuzzy_min_score=0.7,
    max_vertical_factor=1.0,
)

for df in table_dfs_marked:
    display(df)