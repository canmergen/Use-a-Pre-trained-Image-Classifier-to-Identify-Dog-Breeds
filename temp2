import re
from typing import List, Dict, Any, Optional, Tuple

# RapidFuzz varsa kullan, yoksa sade eşleme ile devam
try:
    from rapidfuzz import fuzz
    _HAS_RF = True
except Exception:
    _HAS_RF = False

def extract_role_boxes(
    pages_scaled: Any,
    fuzzy_cutoff: int = 86,
    use_fuzzy: bool = True
) -> List[Dict[str, Any]]:
    """
    pages_scaled içindeki rol metinlerini yakalar ve bbox bilgisiyle döner.

    Dönüş: [
      {
        "page_index": int,
        "role": str,                      # kanonik rol
        "matched_text": str,              # OCR metninin orijinali
        "bbox": {"x_min":..., "y_min":..., "width":..., "height":...},
        "confidence": float|None,
        "score": float,                   # eşleşme skoru (0-100)
        "matched_variant": str            # eşleşen varyant (normalize)
      },
      ...
    ]
    """

    # --- 1) Kanonik rol sözlüğü ve varyantları ---
    ROLE_ALIASES_DEFAULT: Dict[str, List[str]] = {
        "toplantı başkanı": [
            "toplantı başkanı","toplanti baskani","top. baskani","topl. baskani","baskan",
            "toplan ti bask ani","toplanıı bask anı","toplanti baska ni","toplanti bsk"
        ],
        "tutanak yazmanı": [
            "tutanak yazmani","tutanak yazmanı","yazman","yazmani"
        ],
        "bakanlık temsilcisi": [
            "bakanlik temsilcisi","ticaret bakanligi temsilcisi","ticaret bakanligi temsilcist",
            "ticaret bakanligi temsIlcIsI","bakanlik temsIlcIsI"
        ],
        "yönetim kurulu başkanı": [
            "yönetim kurulu başkanı","yonetim kurulu baskani","yk baskani","yk bsk","yk bsk."
        ],
        "yönetim kurulu üyesi": [
            "yönetim kurulu üyesi","yonetim kurulu uyesi","yk uyesi","yk uye","yk. uyesi",
            # sadece "yönetim kurulu" görüldüğünde bu role düşecek (kural aşağıda)
            "yönetim kurulu","yonetim kurulu","yk"
        ],
        "katip": [
            "katip","kâtıp","kâtip","ka tip"
        ],
        "divan başkanı": [
            "divan başkanı","divan baskani","divan bsk"
        ],
        "oy toplama memuru": [
            "oy toplama memuru","oy sayım memuru","oy sayim memuru","oy toplama gorevlisi"
        ],
        "noter": [
            "noter","noterce","noter onaylı","noter onayli"
        ],
    }

    # --- 2) Normalizasyon yardımcıları ---
    def fold(s: str) -> str:
        s = s.lower()
        s = s.replace("ı","i").replace("İ","i").replace("ş","s").replace("Ş","s") \
             .replace("ç","c").replace("Ç","c").replace("ö","o").replace("Ö","o") \
             .replace("ğ","g").replace("Ğ","g").replace("ü","u").replace("Ü","u")
        s = s.replace("|","l").replace("’","'").replace("“","\"").replace("”","\"")
        s = re.sub(r"\s+", " ", s).strip()
        # 3+ tekrar eden karakterleri yumuşat
        s = re.sub(r"(.)\1{2,}", r"\1\1", s)
        return s

    # aliasları normalize edip uzun olanları önce deneyeceğiz
    canon_by_variant: Dict[str, str] = {}
    all_variants: List[Tuple[str, str]] = []  # (variant_norm, canon)
    for canon, vals in ROLE_ALIASES_DEFAULT.items():
        for v in vals:
            vv = fold(v)
            canon_by_variant[vv] = canon
            all_variants.append((vv, canon))
    # uzun varyantlar önce
    all_variants.sort(key=lambda x: len(x[0]), reverse=True)

    def ensure_pages(pages_obj: Any) -> List[List[Dict[str, Any]]]:
        """Tek sayfa listesi de gelse [ [items...] ] şekline çevir."""
        if not pages_obj:
            return []
        # sayfa düzeyi liste mi? (içindeki ilk eleman dictionary ise tek sayfa)
        if isinstance(pages_obj, list) and pages_obj and isinstance(pages_obj[0], dict):
            return [pages_obj]
        return pages_obj  # zaten [ [dict,...], [dict,...] ]

    pages = ensure_pages(pages_scaled)
    out: List[Dict[str, Any]] = []

    # --- 3) Eşleme ana akışı ---
    for pi, items in enumerate(pages):
        for it in items:
            txt = it.get("text") or it.get("txt") or ""
            if not txt:
                continue
            bbox = it.get("bbox") or {}
            conf = it.get("confidence")

            raw_norm = fold(txt)
            raw_ns = raw_norm.replace(" ", "")

            best: Optional[Tuple[str, str, float]] = None  # (canon, matched_variant, score)
            matched_only_yk = False  # sadece "yönetim kurulu" kuralı için

            # 3.a: özel kural – YK başkanı > üye, ayrımı
            if ("yonetim kurulu baskan" in raw_norm) or ("yönetim kurulu başkan" in raw_norm) or ("yk bask" in raw_norm):
                best = ("yönetim kurulu başkanı", "yonetim kurulu baskani", 100.0)
            else:
                # 3.b: varyantlara göre doğrudan içerme / nospace içerme
                for variant, canon in all_variants:
                    v_ns = variant.replace(" ", "")
                    hit = False
                    if variant in raw_norm or v_ns in raw_ns:
                        hit = True
                        score = 100.0
                    elif use_fuzzy and _HAS_RF:
                        # partial match, OCR artıkları için daha toleranslı
                        score = max(
                            fuzz.partial_ratio(variant, raw_norm),
                            fuzz.partial_ratio(variant, raw_ns)
                        )
                        hit = score >= fuzzy_cutoff
                    else:
                        score = 0.0

                    if hit:
                        # "yönetim kurulu" tek başına ise üye kuralını uygula
                        if canon == "yönetim kurulu üyesi" and (
                            "yonetim kurulu baskan" in raw_norm or "yönetim kurulu başkan" in raw_norm or "yk bask" in raw_norm
                        ):
                            # başkan sinyali varsa üye yerine başkan olacak, bir üstte zaten yakalanırdı
                            continue

                        if best is None or score > best[2]:
                            best = (canon, variant, float(score))

                        if variant in ("yönetim kurulu","yonetim kurulu","yk"):
                            matched_only_yk = True

            if best:
                canon, matched_variant, score = best

                # “yalnızca yönetim kurulu” ⇒ üye
                if matched_only_yk and canon != "yönetim kurulu başkanı":
                    canon = "yönetim kurulu üyesi"

                out.append({
                    "page_index": pi,
                    "role": canon,
                    "matched_text": txt,
                    "bbox": {
                        "x_min": bbox.get("x_min"),
                        "y_min": bbox.get("y_min"),
                        "width": bbox.get("width"),
                        "height": bbox.get("height"),
                    },
                    "confidence": conf if isinstance(conf, (int, float)) else None,
                    "score": round(score, 1),
                    "matched_variant": fold(matched_variant)
                })

    # Aynı kutu için birden fazla rol bulunursa, en yüksek skoru tut
    def _key(r):
        b = r["bbox"]
        return (r["page_index"], b["x_min"], b["y_min"], b["width"], b["height"])
    best_by_box: Dict[Any, Dict[str, Any]] = {}
    for r in out:
        k = _key(r)
        if k not in best_by_box or r["score"] > best_by_box[k]["score"]:
            best_by_box[k] = r
    return list(best_by_box.values())

# pages_scaled = [...]  # senin OCR çıktın
role_boxes = extract_role_boxes(pages_scaled, fuzzy_cutoff=86)

# Örnek çıktı elemanı:
# {
#   'page_index': 0,
#   'role': 'toplantı başkanı',
#   'matched_text': 'TOPLANTI BAŞKANI: CİHAN DEMİR',
#   'bbox': {'x_min': 524, 'y_min': 188, 'width': 753, 'height': 95},
#   'confidence': 0.938,
#   'score': 100.0,
#   'matched_variant': 'toplanti baskani'
# }