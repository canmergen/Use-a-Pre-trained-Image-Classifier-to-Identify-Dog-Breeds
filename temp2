from difflib import SequenceMatcher
from typing import List, Dict, Any, Tuple
import numpy as np


def mark_signatures_on_imza_column(
    table_dfs: List["pd.DataFrame"],
    page_cells_all: List[List[Dict[str, Any]]],
    sig_boxes: List[Dict[str, Any]],
    signature_header_target: str = "IMZA",   # veya "İMZA"
    fuzzy_min_score: float = 0.7,
    sig_cover_threshold: float = 0.15,       # imzanın en az %15'i hücre içinde
    cell_cover_threshold: float = 0.08,      # hücrenin en az %8'i imza ile kaplı
    center_pad_factor_top: float = 0.3,      # hücre üstüne h*0.3 tolerans
    center_pad_factor_bottom: float = 0.3,   # hücre altına h*0.3 tolerans
    cell_padding_px: int = 4,                # overlap hesabında hücreyi büyüt
    debug: bool = False,
):
    """
    Satır-merkezli imza işaretleme (DataFrame satır sırasına göre).

    Adımlar:
      1) Her sayfa için İMZA kolonundaki hücreleri al, dikey merkezlerine göre sırala.
      2) Aynı sayfanın DataFrame indekslerini sırayla al: idx_list = list(df.index).
      3) k. hücre, idx_list[k] satırına karşılık gelir.
      4) Her hücre için:
           - İmza merkezleri hücrenin dikey aralığı (biraz genişletilmiş) içinde mi?
           - Değilse alan kesişimi imza/hücre oranı eşikleri geçiyor mu?
         Eğer evet → ilgili satırın IMZA kolonuna 1 yaz.
    """

    # 1) YOLO çıktısını normalize et: (image_index, x_min, y_min, x_max, y_max)
    norm_sigs: List[Dict[str, Any]] = []

    for sb in sig_boxes:
        img_idx = sb.get("image_index", 0)
        boxes = sb.get("boxes", [])

        for b in boxes:
            # b: {"xyxy":[x1,y1,x2,y2], ...} benzeri yapı
            xyxy = (
                b.get("xyxy")
                or b.get("bbox")
                or b.get("xxyy")
                or b
            )
            if xyxy is None or len(xyxy) != 4:
                continue

            x1, y1, x2, y2 = map(float, xyxy)

            norm_sigs.append(
                {
                    "image_index": int(img_idx),
                    "x_min": x1,
                    "y_min": y1,
                    "x_max": x2,
                    "y_max": y2,
                }
            )

    # 2) Overlap ölçüleri (padding ile)
    def overlap_measures(cell: Dict[str, Any], sig: Dict[str, Any]) -> Tuple[float, float, float]:
        """
        return (intersection_area, frac_sig, frac_cell)
          intersection_area: kesişim alanı
          frac_sig         : imza alanının yüzde kaçı hücre içinde
          frac_cell        : hücre alanının yüzde kaçı imza ile kaplı
        """

        cx = float(cell["x"])
        cy = float(cell["y"])
        cw = float(cell["w"])
        ch = float(cell["h"])

        # Hücreyi px bazında büyüt
        x1c = cx - cell_padding_px
        y1c = cy - cell_padding_px
        x2c = cx + cw + cell_padding_px
        y2c = cy + ch + cell_padding_px

        xA = max(x1c, sig["x_min"])
        yA = max(y1c, sig["y_min"])
        xB = min(x2c, sig["x_max"])
        yB = min(y2c, sig["y_max"])

        inter_w = max(0.0, xB - xA)
        inter_h = max(0.0, yB - yA)
        inter_area = inter_w * inter_h

        if inter_area <= 0:
            return 0.0, 0.0, 0.0

        area_cell = (x2c - x1c) * (y2c - y1c)
        area_sig = (sig["x_max"] - sig["x_min"]) * (sig["y_max"] - sig["y_min"])

        frac_sig = inter_area / area_sig if area_sig > 0 else 0.0
        frac_cell = inter_area / area_cell if area_cell > 0 else 0.0

        return inter_area, frac_sig, frac_cell

    # 3) Kolon adını fuzzy ile bul
    def fuzzy_best_col(columns, target: str):
        best_col = None
        best_score = 0.0
        t = target.upper()

        for col in columns:
            s = SequenceMatcher(None, str(col).upper(), t).ratio()
            if s > best_score:
                best_score = s
                best_col = col
        return best_col, best_score

    # 4) Her sayfa için imza kolonunu 0/1 olarak doldur
    result_dfs: List["pd.DataFrame"] = []

    for page_index, df in enumerate(table_dfs):
        if df is None or df.empty:
            result_dfs.append(df)
            continue

        # "page_index" hariç kolonlar
        data_cols = [c for c in df.columns if c != "page_index"]

        sig_col_name, score = fuzzy_best_col(data_cols, signature_header_target)

        # imza başlığı yoksa olduğu gibi bırak
        if sig_col_name is None or score < fuzzy_min_score:
            result_dfs.append(df)
            continue

        sig_col_pos = data_cols.index(sig_col_name)

        # İMZA kolonunu 0 ile başlat
        df[sig_col_name] = 0

        # Sayfanın hücreleri ve imzaları
        cells = page_cells_all[page_index]
        page_sigs = [s for s in norm_sigs if s["image_index"] == page_index]

        if not cells or not page_sigs:
            result_dfs.append(df)
            continue

        # Sadece imza kolonundaki hücreler
        imza_cells = [c for c in cells if c["col"] == sig_col_pos]
        if not imza_cells:
            result_dfs.append(df)
            continue

        # Hücreleri dikey merkezlerine göre sırala
        for c in imza_cells:
            c["_center_y"] = float(c["y"]) + 0.5 * float(c["h"])
        imza_cells_sorted = sorted(imza_cells, key=lambda c: c["_center_y"])

        # DataFrame satır indekslerini sırala (gördüğün sıra)
        idx_list = list(df.index)

        if debug:
            print(
                f"\n[DEBUG] page {page_index}: {len(imza_cells_sorted)} imza hücresi, "
                f"{len(page_sigs)} imza bbox'u, df_rows={len(idx_list)}"
            )

        # Her hücreyi sırayla bir DataFrame satırına eşle
        n_pairs = min(len(imza_cells_sorted), len(idx_list))

        for ci in range(n_pairs):
            cell = imza_cells_sorted[ci]
            row_idx = idx_list[ci]  # CRITICAL: row yerine DF sırasını kullan

            cy = float(cell["y"])
            ch = float(cell["h"])

            # Merkez-eşik aralığı
            top_pad = center_pad_factor_top * ch
            bottom_pad = center_pad_factor_bottom * ch
            center_min = cy - top_pad
            center_max = cy + ch + bottom_pad

            marked = False
            best_frac_sig = 0.0
            best_frac_cell = 0.0

            for si, sig in enumerate(page_sigs):
                sy_center = 0.5 * (sig["y_min"] + sig["y_max"])

                # 1) Merkez bu satır aralığı içinde mi?
                if center_min <= sy_center <= center_max:
                    marked = True
                    if debug:
                        print(
                            f"[DEBUG] page {page_index} cell#{ci} -> row={row_idx} "
                            f"CENTER hit by sig#{si}"
                        )
                    break

                # 2) Aksi halde overlap oranlarına bak
                inter_area, frac_sig, frac_cell = overlap_measures(cell, sig)
                if inter_area > 0:
                    if frac_sig > best_frac_sig:
                        best_frac_sig = frac_sig
                    if frac_cell > best_frac_cell:
                        best_frac_cell = frac_cell

            # Eğer merkez ile işaretlenmediyse, oranlara göre işaretle
            if not marked:
                if (best_frac_sig >= sig_cover_threshold) or (best_frac_cell >= cell_cover_threshold):
                    marked = True
                    if debug:
                        print(
                            f"[DEBUG] page {page_index} cell#{ci} -> row={row_idx} "
                            f"OVERLAP hit (frac_sig={best_frac_sig:.3f}, "
                            f"frac_cell={best_frac_cell:.3f})"
                        )

            if marked and row_idx in df.index:
                df.at[row_idx, sig_col_name] = 1

        # temp alanı temizle
        for c in imza_cells:
            c.pop("_center_y", None)

        result_dfs.append(df)

    return result_dfs

table_dfs_marked = mark_signatures_on_imza_column(
    table_dfs=table_df,
    page_cells_all=page_cells_all,
    sig_boxes=sig_boxes,
    signature_header_target="İMZA",
    fuzzy_min_score=0.7,
    sig_cover_threshold=0.15,
    cell_cover_threshold=0.08,
    center_pad_factor_top=0.3,
    center_pad_factor_bottom=0.3,
    cell_padding_px=4,
    debug=True,
)

for df in table_dfs_marked:
    display(df)