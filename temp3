def llm_rewrite_regions_texts_using_page_text(paddle_ocr_regions, paddle_ocr_texts,
                                              temperature: float = 0.0,
                                              max_tokens: int = 180,
                                              window_chars: int = 280):
    """
    LLM (Gemma) kullanarak regions[j]['text'] değerlerini, aynı sayfanın
    paddle_ocr_texts[i] metnine göre düzeltir. BBox'lar korunur, sadece 'text' güncellenir.

    Gereken: paddleocr_usage.response_generation_v_gemma(system_message, user_input, temp, max_t)
    """

    import re, unicodedata

    assert len(paddle_ocr_regions) == len(paddle_ocr_texts), "Uzunluklar uyuşmuyor."

    # --- Normalizasyon yardımcıları ---
    def _norm(s: str) -> str:
        if not isinstance(s, str): return ""
        s = unicodedata.normalize("NFKC", s)
        s = (s.replace("•"," ").replace("·"," ").replace("§","S")
               .replace("|"," ").replace("¦"," ").replace("—","-").replace("–","-")
               .replace("İ","İ").replace("i̇","i")
               .replace("Ş","Ş").replace("Ğ","Ğ").replace("Ç","Ç").replace("Ü","Ü")
               .replace("ş","ş").replace("ğ","ğ").replace("ç","ç").replace("ü","ü"))
        s = re.sub(r"\s*([.,:;/()\-])\s*", r"\1", s)     # 25 . 000 , 00 -> 25.000,00
        s = re.sub(r"\s+", " ", s).strip()
        return s

    def _digits_mask(s: str) -> str:
        return re.sub(r"\d", "#", s or "")

    def _slice_with_query(page_text: str, box_text: str, radius: int) -> str:
        """
        Sayfa metninden, bbox metni benzeri bir parça etrafında bağlam penceresi çıkar.
        Basit arama: normalize edip ilk geçen küçük alt ifadeyi arar,
        bulunamazsa sayfayı kısaltıp döner.
        """
        pt = _norm(page_text)
        q  = _norm(box_text)[:40]  # kısa ipucu
        idx = -1
        if q:
            # 20+ karakterlik bir parça yakalamaya çalış
            for k in range(min(len(q), 40), 8, -2):
                sub = q[:k]
                idx = pt.find(sub)
                if idx != -1: break
        if idx == -1:
            # bulunamadıysa sayfanın ortasından pencere
            mid = max(0, len(pt)//2 - radius)
            return pt[mid: mid + 2*radius]
        start = max(0, idx - radius)
        end   = min(len(pt), idx + len(q) + radius)
        return pt[start:end]

    # --- Sert kurallı sistem mesajı ---
    SYSTEM_PROMPT = (
        "Türkçe OCR düzeltme yardımcısısın.\n"
        "Kurallar:\n"
        "1) Yalnızca yazım/boşluk/diakritik düzelt; içerik ekleme/çıkarma yapma.\n"
        "2) Sayıları ve biçimlerini (binlik/ondalık) KESİNLİKLE koru.\n"
        "3) Mümkünse ÇIKTI, verilen SAYFA METNİ içinde birebir geçen EN YAKIN ifadeyi seçsin.\n"
        "4) ÇIKTI tek satır düz metin olacak; başka açıklama, etiket veya alıntı işareti ekleme.\n"
    )

    for page_idx, (regions, page_text) in enumerate(zip(paddle_ocr_regions, paddle_ocr_texts)):
        if not regions: 
            continue

        # Her bbox için LLM çağrısı
        for r in regions:
            src_raw  = r.get("text", "")
            src_norm = _norm(src_raw)
            if not src_norm:
                r["text"] = ""
                continue

            context = _slice_with_query(page_text, src_norm, radius=window_chars//2)

            user_prompt = (
                "SAYFA METNİ:\n"
                f"{context}\n\n"
                "BBOX METNİ (hatalı olabilir):\n"
                f"{src_norm}\n\n"
                "Görev: BBOX METNİ'ni SAYFA METNİ içinden en uygun ifadeyle eşleştir ve "
                "yalnızca düzeltilmiş ifadeyi yaz. Numara ve noktalama biçimini koru."
            )

            try:
                fixed = paddleocr_usage.response_generation_v_gemma(
                    system_message=SYSTEM_PROMPT,
                    user_input=user_prompt,
                    temp=temperature,
                    max_t=max_tokens
                )
                fixed = (fixed or "").strip()
            except Exception:
                fixed = src_norm

            # Güvenlik kontrolleri: sayı ve aşırı uzama
            if _digits_mask(fixed) != _digits_mask(src_norm):
                # sayılar bozulmuşsa aslına dön
                fixed = src_norm
            if len(fixed) > max(len(src_norm) * 2, 2000):
                fixed = src_norm

            r["text"] = fixed

    return paddle_ocr_regions

paddle_ocr_regions = llm_rewrite_regions_texts_using_page_text(
    paddle_ocr_regions,
    paddle_ocr_texts,
    temperature=0.0,     # deterministik
    max_tokens=180,
    window_chars=280     # bağlam penceresi
)