import cv2
import numpy as np

def binarize_preserve_lines(gray: np.ndarray) -> np.ndarray:
    """
    Global threshold yerine K-means (K=2) kullanarak,
    koyu kümeyi mürekkep (siyah), açık kümeyi arka plan (beyaz) yapar.
    İnce gri çizgiler Otsu'nun attığı durumları toparlar.
    Girdi:  gray (H,W) uint8
    Çıktı:  bw (H,W) uint8, 0=ink, 255=background
    """

    # 1) Kontrastı hafif normalize et (K-means için daha net ayrım)
    norm = cv2.normalize(gray, None, 0, 255, cv2.NORM_MINMAX)

    # 2) K-means için vektörleştir
    Z = norm.reshape(-1, 1).astype(np.float32)

    # 3) K=2 cluster (arka plan / mürekkep)
    criteria = (
        cv2.TERM_CRITERIA_EPS + cv2.TERM_CRITERIA_MAX_ITER,
        10,
        1.0
    )
    K = 2
    _, labels, centers = cv2.kmeans(
        Z, K, None, criteria, 5, cv2.KMEANS_PP_CENTERS
    )

    labels = labels.reshape(norm.shape)
    centers = centers.reshape(-1)  # 2 eleman: [c0, c1]

    # 4) En koyu merkez = mürekkep kümesi
    ink_cluster = int(np.argmin(centers))

    # 5) Kümeleri 0/255'e map et
    bw = np.where(labels == ink_cluster, 0, 255).astype(np.uint8)

    return bw

table_bw = binarize_preserve_lines(table_gray)