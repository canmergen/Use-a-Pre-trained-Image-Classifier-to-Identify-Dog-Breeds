import pandas as pd
import re
from difflib import SequenceMatcher
from typing import List

def standardize_hazirun_tables_fuzzy(
    table_dfs_marked: List[pd.DataFrame],
    page_col: str = "page_index",
    imza_keywords=("imza", "inza"),
    min_score: float = 0.65,
) -> List[pd.DataFrame]:
    """
    table_dfs_marked içindeki her DF'in kolonlarını, fuzzy + keyword kullanarak
    standart hazırun şemasına map eder ve tamamen boş satırları siler.

    Dönüş: List[pd.DataFrame]
        Her DF şu kolonları içerir:
        [page_index,
         pay_sahibinin_adi_soyadi_unvani,
         tckn,
         uyrugu,
         adresi,
         paylarin_toplam_itibari_degeri,
         paylarin_edinim_sekli_tarihi,
         katilim_sekli,
         temsilci_turu,
         temsilci_adi_soyadi_unvani,
         temsilci_tckn,
         tablo_imza_var_mi]
    """

    # Hedef feature adları ve bunlara karşılık gelen "ideal" header metinleri
    target_headers = {
        "pay_sahibinin_adi_soyadi_unvani": "pay sahibinin adi soyadi unvani",
        "tckn":                            "t c v k no tc kimlik no",
        "uyrugu":                          "uyrugu uyruk",
        "adresi":                          "adres",
        "paylarin_toplam_itibari_degeri":  "paylarin toplam itibari degeri tl nominal",
        "paylarin_edinim_sekli_tarihi":    "paylarin edinim sekli ve tarihi",
        "katilim_sekli":                   "katilim sekli asaleten vekaleten",
        "temsilci_turu":                   "temsilci turu katilim sekli temsilci turu",
        "temsilci_adi_soyadi_unvani":      "temsilcinin adi soyadi unvani",
        "temsilci_tckn":                   "temsilcinin t c kimlik vergi no",
        "tablo_imza_var_mi":               "imza",
    }

    # Hedef kolon sırası
    target_order = [
        "pay_sahibinin_adi_soyadi_unvani",
        "tckn",
        "uyrugu",
        "adresi",
        "paylarin_toplam_itibari_degeri",
        "paylarin_edinim_sekli_tarihi",
        "katilim_sekli",
        "temsilci_turu",
        "temsilci_adi_soyadi_unvani",
        "temsilci_tckn",
        "tablo_imza_var_mi",
    ]

    def _norm(s: str) -> str:
        s = str(s or "").lower().strip()
        tr_map = str.maketrans("çğıöşüı", "cgiosui")
        s = s.translate(tr_map)
        s = re.sub(r"[^a-z0-9]+", " ", s)
        s = re.sub(r"\s+", " ", s).strip()
        return s

    def _similar(a: str, b: str) -> float:
        return SequenceMatcher(None, a, b).ratio()

    std_dfs: List[pd.DataFrame] = []

    for df in table_dfs_marked:
        df = df.copy()

        # Kaynak kolonlar (page_index hariç)
        src_cols = [c for c in df.columns if c != page_col]
        src_norm = {c: _norm(c) for c in src_cols}

        used_src = set()
        mapping = {}  # target_name -> src_col or None

        # Önce IMZA kolonunu özel olarak bul
        imza_src = None
        for c in src_cols:
            n = src_norm[c]
            if any(k in n for k in imza_keywords):
                imza_src = c
                used_src.add(c)
                break
        mapping["tablo_imza_var_mi"] = imza_src  # şimdilik; None olabilir

        # Diğer target kolonlar için fuzzy eşleme
        for tgt in target_order:
            if tgt == "tablo_imza_var_mi":
                continue  # IMZA'yı yukarıda yaptık

            tgt_pattern = _norm(target_headers[tgt])
            best_col = None
            best_score = 0.0

            for c in src_cols:
                if c in used_src:
                    continue
                score = _similar(src_norm[c], tgt_pattern)
                if score > best_score:
                    best_score = score
                    best_col = c

            # Yeterli benzerlik varsa ata, yoksa None bırak
            if best_col is not None and best_score >= min_score:
                mapping[tgt] = best_col
                used_src.add(best_col)
            else:
                mapping[tgt] = None

        # tablodaki IMZA kolonunu hâlâ bulamadıysak, en yüksek "imza" benzerliğine göre ara
        if mapping["tablo_imza_var_mi"] is None:
            tgt_pattern = _norm(target_headers["tablo_imza_var_mi"])
            best_col, best_score = None, 0.0
            for c in src_cols:
                if c in used_src:
                    continue
                score = _similar(src_norm[c], tgt_pattern)
                if score > best_score:
                    best_score, best_col = score, c
            if best_col is not None and best_score >= min_score:
                mapping["tablo_imza_var_mi"] = best_col
                used_src.add(best_col)

        # --- Yeni standart DF'i oluştur ---
        std = pd.DataFrame()
        std[page_col] = df[page_col].values

        for tgt in target_order:
            src = mapping.get(tgt)
            if src is not None and src in df.columns:
                std[tgt] = df[src].values
            else:
                std[tgt] = pd.NA

        # --- Tamamen boş satırları sil (page_index + tablo_imza_var_mi hariç) ---
        cols_to_check = [c for c in std.columns
                         if c not in (page_col, "tablo_imza_var_mi")]

        if cols_to_check:
            tmp = std[cols_to_check].astype(str)

            # whitespace + "nan"/"None" temizliği
            tmp = (tmp.apply(lambda s: s.str.replace(r"\s+", "", regex=True))
                     .replace({"nan": "", "None": ""}))

            mask_not_empty = ~tmp.eq("").all(axis=1)
            std = std.loc[mask_not_empty].reset_index(drop=True)

        std_dfs.append(std)

    return std_dfs

tables_df = standardize_hazirun_tables_fuzzy(table_dfs_marked)

for t in tables_df:
    display(t)