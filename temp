import numpy as np
import pandas as pd

def fill_missing_dates_on_df(df: pd.DataFrame, date_col: str = "tarih") -> pd.DataFrame:
    df = df.copy()

    # 1) Tarih kolonundaki 'boş' görünümlerini geçici olarak NaN yap
    if date_col in df.columns:
        df[date_col] = df[date_col].replace({
            "": np.nan,
            " ": np.nan,
            "nan": np.nan,
            "NaN": np.nan,
            "None": np.nan,
            "none": np.nan
        })

    # 2) Grup anahtarı: tarih hariç tüm kolonlar
    key_cols = [c for c in df.columns if c != date_col]

    # 3) Grup içinde tarih doldurma
    for key_vals, grp in df.groupby(key_cols, dropna=False):
        non_null_dates = grp[date_col].dropna().unique()

        # Tek bir geçerli tarih varsa doldur
        if len(non_null_dates) == 1:
            valid_date = non_null_dates[0]
            idx_to_fill = grp[grp[date_col].isna()].index
            df.loc[idx_to_fill, date_col] = valid_date

    # 4) NaN'leri tekrar None yap (objeye çeviriyoruz)
    df[date_col] = df[date_col].astype(object)
    df.loc[df[date_col].isna(), date_col] = None

    return df

table_df_final = fill_missing_dates_on_df(table_df_final, date_col="tarih")