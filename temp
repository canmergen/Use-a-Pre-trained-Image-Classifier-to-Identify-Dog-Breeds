from typing import List, Dict, Tuple, Any
import copy

REQ_KEYS = ("x_min", "y_min", "x_max", "y_max")

def _locate_bbox_container(region: Any):
    """
    region aşağıdakilerden biri olabilir:
      1) {'text':..., 'bbox': {...}}
      2) {'x_min':..., 'y_min':..., 'x_max':..., 'y_max':...}  # doğrudan bbox dict
      3) [ ..., {'bbox': {...}}, ... ]  veya  [ ..., {'x_min':...}, ... ]
    Döndürdüğü: (container, key)  ->  container[key] == bbox_dict
    Bulamazsa (None, None).
    """
    # 1) dict + 'bbox'
    if isinstance(region, dict):
        if "bbox" in region and isinstance(region["bbox"], dict):
            return region, "bbox"
        # 2) dict doğrudan bbox
        if all(k in region for k in REQ_KEYS):
            return {"bbox": region}, "bbox"   # geçici sarmalayıcı döndür
    # 3) list/tuple içinde ara
    if isinstance(region, (list, tuple)):
        for idx, el in enumerate(region):
            if isinstance(el, dict) and "bbox" in el and isinstance(el["bbox"], dict):
                return el, "bbox"
            if isinstance(el, dict) and all(k in el for k in REQ_KEYS):
                return region, idx
    return None, None

def rescale_paddleocr_bboxes(
    pages: List[List[Any]],
    orig_shapes: List[Tuple[int, int]],
    small_size: Tuple[int, int] = (1048, 1048),
    in_place: bool = False,
    clamp: bool = True
) -> List[List[Any]]:
    """
    pages: her sayfa için OCR çıktısı (list of regions). Region nesnesi dict ya da list olabilir.
    orig_shapes: her sayfanın (H, W)
    small_size: OCR'nin çalıştığı küçültülmüş (H_small, W_small)
    YALNIZCA bbox değerleri güncellenir; diğer alanlara dokunulmaz.
    """
    Hs, Ws = small_size  # (height_small, width_small)
    out_pages = pages if in_place else copy.deepcopy(pages)

    for items, (H, W) in zip(out_pages, orig_shapes):
        sx = W / Ws  # x ekseni (genişlik)
        sy = H / Hs  # y ekseni (yükseklik)

        for i, region in enumerate(items):
            container, key = _locate_bbox_container(region)
            if container is None:
                continue  # bu elemanda bbox yok; geç

            b = container[key]
            try:
                x_min = round(b["x_min"] * sx)
                y_min = round(b["y_min"] * sy)
                x_max = round(b["x_max"] * sx)
                y_max = round(b["y_max"] * sy)
            except Exception:
                continue

            # sıra ve sınır düzeltmeleri
            if x_max < x_min: x_min, x_max = x_max, x_min
            if y_max < y_min: y_min, y_max = y_max, y_min
            if clamp:
                x_min = max(0, min(x_min, W - 1))
                x_max = max(0, min(x_max, W - 1))
                y_min = max(0, min(y_min, H - 1))
                y_max = max(0, min(y_max, H - 1))

            b["x_min"], b["y_min"], b["x_max"], b["y_max"] = x_min, y_min, x_max, y_max
            b["width"]  = max(1, x_max - x_min)
            b["height"] = max(1, y_max - y_min)

            # geri yaz
            container[key] = b
            items[i] = region  # (list ise) referansı koru

    return out_pages

# OCR çıktın sayfa bazlıysa doğrudan kullan:
#   pages = paddleocr_regions_aligned  # [ [region, ...], [region, ...], ... ]
# Eğer tek liste ise bir kat sarmala: pages = [paddleocr_regions_aligned]

pages = paddleocr_regions_aligned if isinstance(paddleocr_regions_aligned[0], list) else [paddleocr_regions_aligned]
orig_shapes = [img.shape[:2] for img in final_lower_imgs]  # [(H,W), (H,W), ...]
pages_up = rescale_paddleocr_bboxes(pages, orig_shapes, small_size=(1048, 1048), in_place=False)

# Artık pages_up ile aynı yapıda sonuç alırsın; sadece bbox'lar büyütülmüş.