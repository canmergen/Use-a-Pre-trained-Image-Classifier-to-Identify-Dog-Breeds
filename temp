# Örnek: finallowerimgs içinde numpy array'ler (H,W,3) var (OpenCV style BGR)
from ultralytics import YOLO
import cv2
import numpy as np

# Modeli yükle
model = YOLO("/home/athena/KYCops/TB_KYC_Ops/notebooks/shared/best.pt")

# finallowerimgs: list[np.ndarray] veya tek np.ndarray
# Örnek: finallowerimgs = [img0, img1, ...]   (img dtype=uint8, shape=(H,W,3))
def predict_on_memory_images(finallowerimgs, conf=0.25):
    # normalize input to list
    if isinstance(finallowerimgs, np.ndarray):
        imgs = [finallowerimgs]
    else:
        imgs = finallowerimgs

    # OpenCV BGR -> RGB (Ultralytics expects RGB)
    imgs_rgb = [cv2.cvtColor(img, cv2.COLOR_BGR2RGB) if img.ndim==3 else img for img in imgs]

    # Tahmin (disk I/O yok). save=False, save_txt=False ile disk kaydı engellenir.
    results = model.predict(source=imgs_rgb,
                            save=False,
                            save_txt=False,
                            verbose=False,
                            conf=conf)   # conf: güven eşiği

    # results bir list benzeri objedir; her eleman bir image için Results
    all_boxes = []
    for i, r in enumerate(results):
        # r.boxes: ultralytics Boxes objesi
        # xyxy: (N,4) -> [x1, y1, x2, y2] (piksel koordinatlarda)
        # cls: sınıf id, conf: güven
        boxes = []
        if hasattr(r, "boxes") and len(r.boxes) > 0:
            xyxy = r.boxes.xyxy.cpu().numpy()        # shape (N,4)
            confs = r.boxes.conf.cpu().numpy()       # shape (N,)
            clsids = r.boxes.cls.cpu().numpy().astype(int)  # shape (N,)
            for b, c, cl in zip(xyxy, confs, clsids):
                x1, y1, x2, y2 = b.tolist()
                boxes.append({
                    "xyxy": [float(x1), float(y1), float(x2), float(y2)],
                    "conf": float(c),
                    "class_id": int(cl)
                })
        all_boxes.append({
            "image_index": i,
            "orig_shape": imgs[i].shape,   # (H,W,3)
            "boxes": boxes
        })
    return all_boxes, results

# Kullanım:
# all_boxes, results = predict_on_memory_images(finallowerimgs, conf=0.25)

# Eğer görselleştirmek istersen (annotated image array döner):
# annotated = results[0].plot()   # numpy image (RGB) -> istersen cv2.cvtColor ile BGR'ye çevirip gösterirsin