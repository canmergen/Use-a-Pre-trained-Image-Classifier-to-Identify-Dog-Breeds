import pandas as pd
from collections import defaultdict
from typing import List, Dict, Any, Tuple

def build_tables_from_pages(
    pages_scaled: List[List[Dict[str, Any]]],
    page_cells_all: List[List[Dict[str, Any]]],
    header_row: int = 0,
    min_conf: float = 0.0,
) -> Tuple[List[pd.DataFrame], pd.DataFrame]:
    """
    pages_scaled[p]      : OCR kutuları listesi (dict: 'text', 'bbox', 'confidence' ...)
    page_cells_all[p]    : Hücre listesi (dict: 'page','row','col','x','y','w','h')
    header_row           : Her sayfada kolon isimlerinin olduğu satır index'i
    min_conf             : OCR kutuları için minimum confidence filtresi

    Dönüş:
      dfs_per_page : her sayfa için ayrı DataFrame listesi
      full_df      : tüm sayfaların concat hali, 'page_index' kolonu ile
    """

    def _build_table_for_page(p_index: int) -> pd.DataFrame:
        ocr_boxes = pages_scaled[p_index]
        cells     = page_cells_all[p_index]

        # (row, col) -> hücre bbox
        cell_rects = {(c["row"], c["col"]): c for c in cells}

        # (row, col) -> metin listesi
        texts_by_cell = defaultdict(list)

        # OCR kutularını ilgili hücrelere ata
        for box in ocr_boxes:
            if "bbox" not in box:
                continue
            if ("confidence" in box) and (box["confidence"] < min_conf):
                continue

            bb = box["bbox"]
            x0 = bb.get("x_min", bb.get("left", 0))
            y0 = bb.get("y_min", bb.get("top", 0))
            x1 = bb.get("x_max", x0 + bb.get("width", 0))
            y1 = bb.get("y_max", y0 + bb.get("height", 0))

            cx = 0.5 * (x0 + x1)
            cy = 0.5 * (y0 + y1)

            for (r, c), cell in cell_rects.items():
                x, y, w, h = cell["x"], cell["y"], cell["w"], cell["h"]
                if (x <= cx < x + w) and (y <= cy < y + h):
                    texts_by_cell[(r, c)].append(box.get("text", ""))
                    break

        # grid boyutları
        max_row = max(c["row"] for c in cells)
        max_col = max(c["col"] for c in cells)

        # 2D tabloyu doldur
        table = []
        for r in range(max_row + 1):
            row_vals = []
            for c in range(max_col + 1):
                toks = texts_by_cell.get((r, c), [])
                txt  = " ".join(toks).strip()
                row_vals.append(txt)
            table.append(row_vals)

        # header + data
        header    = table[header_row]
        data_rows = table[header_row + 1:]

        df = pd.DataFrame(data_rows, columns=header)
        df.insert(0, "page_index", p_index)  # her satıra page_index ekle
        return df

    # Tüm sayfalar için çalıştır
    n_pages = min(len(pages_scaled), len(page_cells_all))
    dfs_per_page: List[pd.DataFrame] = []

    for p in range(n_pages):
        df_p = _build_table_for_page(p)
        dfs_per_page.append(df_p)

    # Hepsini tek DF'de birleştir
    if dfs_per_page:
        full_df = pd.concat(dfs_per_page, ignore_index=True)
    else:
        full_df = pd.DataFrame()

    return dfs_per_page, full_df

dfs_per_page, full_df = build_tables_from_pages(
    pages_scaled=pages_scaled,
    page_cells_all=page_cells_all,
    header_row=0,
    min_conf=0.0,
)

# Örneğin:
df_page0 = dfs_per_page[0]
df_page1 = dfs_per_page[1]
df_page2 = dfs_per_page[2]