import cv2
import numpy as np

def auto_fix_table_lines(table_bin: np.ndarray, line_thickness: int = 3):
    """
    Tablo içindeki yatay ve dikey çizgileri otomatik tespit eder,
    sadece bu çizgileri kalınlaştırır ve kopuklukları kapatır.
    Parametre gerektirmez. Çizgiler Hough transform ile bulunur.
    """

    # --- 1) Tek kanal garanti ---
    if len(table_bin.shape) == 3:
        gray = cv2.cvtColor(table_bin, cv2.COLOR_BGR2GRAY)
    else:
        gray = table_bin.copy()

    # --- 2) Kesin binary formata getir ---
    _, bw = cv2.threshold(gray, 0, 255, cv2.THRESH_BINARY + cv2.THRESH_OTSU)

    # Çizgileri beyaz yap (morfoloji kolaylığı)
    inv = 255 - bw

    # --- 3) Kenarları belirle ---
    edges = cv2.Canny(inv, 50, 150, apertureSize=3)

    # --- 4) Hough Lines (çizgi tespiti TAM OTOMATİK) ---
    lines = cv2.HoughLinesP(
        edges,
        rho=1,
        theta=np.pi/180,
        threshold=80,
        minLineLength=50,     # otomatik davranır
        maxLineGap=20         # kopuklukların kapanması için
    )

    # Yeni boş bir maske
    line_mask = np.zeros_like(inv)

    # --- 5) Bulunan çizgileri kalınlaştırarak çiz ---
    if lines is not None:
        for (x1, y1, x2, y2) in lines[:, 0]:
            cv2.line(line_mask, (x1, y1), (x2, y2), 255, line_thickness)

    # --- 6) İnvert et ve 0–255 formatında döndür ---
    line_mask = np.clip(line_mask, 0, 255).astype(np.uint8)
    return line_mask

fixed_tables = [
    auto_fix_table_lines(img, line_thickness=3)
    for img in binarized_tables
]

# Görmek için
for i, img in enumerate(fixed_tables):
    plt.figure(figsize=(6,8))
    plt.title(f"Table {i} – auto line fix")
    plt.imshow(img, cmap="gray")
    plt.axis("off")
    plt.show()