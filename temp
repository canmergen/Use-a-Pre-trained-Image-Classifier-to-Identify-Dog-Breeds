import numpy as np
import pandas as pd

def fill_missing_dates_on_df(
    df: pd.DataFrame,
    date_col: str = "tarih",
    group_cols: list[str] | None = None
) -> pd.DataFrame:
    """
    df üzerinde, tarih kolonu boş olan satırları güvenli şekilde doldurur.

    - Tarih kolonu içindeki "", "nan", "None" vb. değerleri geçici olarak NaN yapar.
    - group_cols'a göre gruplayıp, grup içinde *tek bir* geçerli tarih varsa
      o gruptaki diğer satırların tarihlerini de aynı yapar.
    - En sonda NaN'leri tekrar None'a çevirir.
    """

    df = df.copy()

    if date_col not in df.columns:
        return df

    # 1) Tarih kolonundaki 'boş' görünümleri geçici olarak NaN yap
    df[date_col] = (
        df[date_col]
        .replace(
            {
                "": np.nan,
                " ": np.nan,
                "nan": np.nan,
                "NaN": np.nan,
                "NONE": np.nan,
                "None": np.nan,
            }
        )
    )

    # 2) Grup anahtarını belirle
    if group_cols is None:
        # Tercihen: page_index + şirket bilgisi ile grupla
        preferred = [
            "page_index",
            "şirket_adı",
            "şirket_türü",
            "sirket_adi",
            "sirket_turu",
        ]
        group_cols = [c for c in preferred if c in df.columns]

        # Hiçbiri yoksa en azından page_index'e göre grupla (varsa)
        if not group_cols and "page_index" in df.columns:
            group_cols = ["page_index"]

        # Hâlâ yoksa dolduracak anlamlı bir grup yok, direkt dön
        if not group_cols:
            df[date_col] = df[date_col].astype(object)
            df.loc[df[date_col].isna(), date_col] = None
            return df

    # 3) Her grup içinde tarih doldurma
    for _, idx in df.groupby(group_cols, dropna=False).groups.items():
        g = df.loc[idx, date_col]
        non_null_dates = pd.Series(g).dropna().unique()

        # Sadece tek bir geçerli tarih varsa doldur
        if len(non_null_dates) == 1:
            valid_date = non_null_dates[0]
            to_fill = g.isna()
            if to_fill.any():
                df.loc[idx[to_fill], date_col] = valid_date

    # 4) NaN'leri tekrar None yap
    df[date_col] = df[date_col].astype(object)
    df.loc[df[date_col].isna(), date_col] = None

    return df

