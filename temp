import pandas as pd
import numpy as np

def fill_missing_dates_by_row(df: pd.DataFrame, date_col: str = "tarih") -> pd.DataFrame:
    """
    - tarih kolonundaki eksikleri, aynı satır içeriğine sahip (tarih hariç) satırlardan gelen tekil tarihle doldurur.
    - Aynı grupta birden fazla farklı tarih varsa grubun hiçbir satırına dokunmaz.
    """
    df_out = df.copy()

    if date_col not in df_out.columns:
        return df_out

    # Tarih kolonu object kalsın
    df_out[date_col] = df_out[date_col].astype(object)

    # Grup anahtarı: tarih dışındaki tüm sütunlar
    key_cols = [c for c in df_out.columns if c != date_col]

    # Hiç key yoksa bir şey yapma
    if not key_cols:
        return df_out

    for _, grp in df_out.groupby(key_cols, dropna=False):
        idx = grp.index

        s = grp[date_col]

        # Geçerli tarih değerleri (None/NaN/boş/nan/none hariç)
        s_str = s.astype(str).str.strip()
        mask_valid = ~s_str.str.lower().isin(["", "nan", "none"])
        valid_vals = s_str[mask_valid].unique()

        # Tek bir farklı tarih varsa doldur
        if len(valid_vals) == 1:
            fill_val = valid_vals[0]

            # Eksik olanlar: None, NaN, "", "nan", "none"
            mask_missing = s.isna() | s_str.str.lower().isin(["", "nan", "none"])
            df_out.loc[idx[mask_missing], date_col] = fill_val

    return df_out

df = fill_missing_dates_by_row(df, date_col="tarih")