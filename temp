import numpy as np
import pandas as pd
from difflib import SequenceMatcher

def mark_signatures_on_imza_column(
    table_dfs,
    page_cells_all,
    sig_boxes,
    signature_header_target="IMZA",   # veya "İMZA"
    iou_threshold=0.05,
    fuzzy_min_score=0.7,
):
    """
    table_dfs      : list[pd.DataFrame]  -> her sayfanın tablosu
    page_cells_all : list[list[dict]]    -> her sayfa için hücreler
    sig_boxes      : YOLO imza çıktısı listesi
    """

    # 1) Sig kutularını normalize et
    norm_sigs = []
    for sb in sig_boxes:
        img_idx = sb.get("image_index", 0)
        for b in sb.get("boxes", []):
            xyxy = b.get("xyxy") or b.get("bbox") or b
            x1, y1, x2, y2 = map(float, xyxy)
            norm_sigs.append(
                {
                    "image_index": img_idx,
                    "x_min": x1,
                    "y_min": y1,
                    "x_max": x2,
                    "y_max": y2,
                }
            )

    def iou_cell_sig(cell, sig):
        xA = max(cell["x"], sig["x_min"])
        yA = max(cell["y"], sig["y_min"])
        xB = min(cell["x"] + cell["w"], sig["x_max"])
        yB = min(cell["y"] + cell["h"], sig["y_max"])

        inter_w = max(0.0, xB - xA)
        inter_h = max(0.0, yB - yA)
        inter = inter_w * inter_h
        if inter <= 0:
            return 0.0

        area_cell = float(cell["w"] * cell["h"])
        area_sig = float((sig["x_max"] - sig["x_min"]) * (sig["y_max"] - sig["y_min"]))
        return inter / (area_cell + area_sig - inter)

    def fuzzy_best_col(columns, target):
        best_col = None
        best_score = 0.0
        t = target.upper()
        for col in columns:
            s = SequenceMatcher(None, str(col).upper(), t).ratio()
            if s > best_score:
                best_score = s
                best_col = col
        return best_col, best_score

    result_dfs = []

    for page_index, df in enumerate(table_dfs):
        if df is None or df.empty:
            result_dfs.append(df)
            continue

        # imza kolonunu fuzzy ile bul (page_index hariç)
        data_cols = [c for c in df.columns if c != "page_index"]
        sig_col_name, score = fuzzy_best_col(data_cols, signature_header_target)
        if sig_col_name is None or score < fuzzy_min_score:
            # imza başlığı bulunamadı → aynen bırak
            result_dfs.append(df)
            continue

        sig_col_pos = data_cols.index(sig_col_name)

        # İMZA kolonunu 0/1'e çevirmeye hazırlık
        df[sig_col_name] = 0

        cells = page_cells_all[page_index]
        page_sigs = [s for s in norm_sigs if s["image_index"] == page_index]

        if not cells or not page_sigs:
            result_dfs.append(df)
            continue

        # sadece imza kolonundaki hücrelere bak
        for sig in page_sigs:
            for cell in cells:
                if cell["col"] != sig_col_pos:
                    continue
                ov = iou_cell_sig(cell, sig)
                if ov > iou_threshold:
                    row_idx = cell["row"]
                    if row_idx in df.index:
                        df.at[row_idx, sig_col_name] = 1

        result_dfs.append(df)

    return result_dfs

table_dfs_marked = mark_signatures_on_imza_column(
    table_dfs=table_df,          # build_tables_from_pages çıktısı (list of df)
    page_cells_all=page_cells_all,
    sig_boxes=sig_boxes,
    signature_header_target="İMZA",  # başlıkta nasılsa
    iou_threshold=0.05,
    fuzzy_min_score=0.7,
)

for df in table_dfs_marked:
    display(df)