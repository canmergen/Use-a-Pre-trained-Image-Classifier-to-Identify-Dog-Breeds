import cv2
import numpy as np

def close_table_line_gaps(table_bin: np.ndarray,
                          horiz_scale: int = 40,
                          vert_scale: int = 40,
                          close_iters: int = 1,
                          dilate_iters: int = 1) -> np.ndarray:
    """
    table_bin: 0-255, tek kanallı, sadece tablo görüntüsü (binarize edilmiş).
               Çizgiler ve yazılar siyah, arka plan beyaz varsayılıyor.

    Çıktı: çizgi kopuklukları kapatılmış, sadece grid maskesi (0/255).
    """

    # Gri hale getir ve tekrar binarize et (garanti olsun)
    if len(table_bin.shape) == 3:
        gray = cv2.cvtColor(table_bin, cv2.COLOR_BGR2GRAY)
    else:
        gray = table_bin.copy()

    _, bw = cv2.threshold(gray, 0, 255,
                          cv2.THRESH_BINARY + cv2.THRESH_OTSU)

    # Arka plan beyaz, çizgiler siyah mı kontrol et; değilse invert et
    if np.mean(bw) < 127:
        bw = 255 - bw

    # Çizgileri 1, arka plan 0 olacak şekilde invert (morfoloji için daha rahat)
    inv = 255 - bw

    h, w = inv.shape

    # Kernel boylarını imaj boyutuna göre dinamik ayarla
    # (tablonun genişliğinin /40'ı kadar bir uzunluk genelde iyi çalışıyor)
    horiz_kernel_len = max(10, w // horiz_scale)
    vert_kernel_len  = max(10, h // vert_scale)

    horiz_kernel = cv2.getStructuringElement(
        cv2.MORPH_RECT, (horiz_kernel_len, 1)
    )
    vert_kernel = cv2.getStructuringElement(
        cv2.MORPH_RECT, (1, vert_kernel_len)
    )

    # 1) Yatay çizgi maskesi çıkar
    horiz_lines = cv2.erode(inv, horiz_kernel, iterations=1)
    horiz_lines = cv2.dilate(horiz_lines, horiz_kernel, iterations=1)

    # Kopuklukları kapat (closing)
    horiz_lines = cv2.morphologyEx(
        horiz_lines, cv2.MORPH_CLOSE, horiz_kernel, iterations=close_iters
    )
    horiz_lines = cv2.dilate(horiz_lines, horiz_kernel, iterations=dilate_iters)

    # 2) Dikey çizgi maskesi çıkar
    vert_lines = cv2.erode(inv, vert_kernel, iterations=1)
    vert_lines = cv2.dilate(vert_lines, vert_kernel, iterations=1)

    vert_lines = cv2.morphologyEx(
        vert_lines, cv2.MORPH_CLOSE, vert_kernel, iterations=close_iters
    )
    vert_lines = cv2.dilate(vert_lines, vert_kernel, iterations=dilate_iters)

    # 3) Grid maskesi: yatay + dikey
    grid = cv2.bitwise_or(horiz_lines, vert_lines)

    # 4) 0-255'e çevir (mask: çizgi 255, arka plan 0)
    grid = np.clip(grid, 0, 255).astype(np.uint8)

    return grid

closed_line_masks = []
for img in binarized_tables:
    grid_mask = close_table_line_gaps(img,
                                      horiz_scale=40,
                                      vert_scale=40,
                                      close_iters=1,
                                      dilate_iters=1)
    closed_line_masks.append(grid_mask)