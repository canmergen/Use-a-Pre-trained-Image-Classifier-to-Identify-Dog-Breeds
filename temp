import os
import cv2
import numpy as np
from typing import List, Dict, Any, Tuple, Union
import matplotlib.pyplot as plt

def draw_paddle_regions_on_images(
    images: List[np.ndarray],
    regions_pages: Union[List[List[Dict[str, Any]]], List[Dict[str, Any]]],
    scale: Tuple[float, float] = (1.0, 1.0),   # (sx, sy) eğer bbox orijinal ölçekte, image resize edilmişse
    put_text: bool = True,
    max_label_len: int = 40,
    thickness: int = 2,
    save_dir: str = None,                      # örn: "debug_boxes" -> PNG kaydeder
    show: bool = True                          # matplotlib ile göster
) -> List[np.ndarray]:
    """
    images            : final_lower_imgs (List[np.ndarray], GRAY veya BGR)
    regions_pages     : paddle_ocr_regions veya paddle_ocr_regions_aligned
    scale             : bbox koordinatlarını ölçeklemek için (sx, sy)
    put_text          : kutunun üstüne kısa etiket yaz
    max_label_len     : etiketi kısaltma sınırı
    thickness         : çizgi kalınlığı
    save_dir          : klasör verilirse her sayfayı 'page_{i}.png' olarak kaydeder
    show              : True ise ekrana basar
    returns           : üzerinde çizim yapılmış görüntü listesi
    """
    # çok sayfa mı?
    is_multi = len(regions_pages) > 0 and isinstance(regions_pages[0], list)
    pages = regions_pages if is_multi else [regions_pages]

    assert len(images) >= len(pages), "Görüntü sayısı, region sayfalarından az görünüyor."

    os.makedirs(save_dir, exist_ok=True) if save_dir else None
    out_imgs: List[np.ndarray] = []

    sx, sy = scale

    for i, (img, regs) in enumerate(zip(images, pages)):
        # BGR'ye çevir
        if img.ndim == 2:
            canvas = cv2.cvtColor(img, cv2.COLOR_GRAY2BGR)
        else:
            canvas = img.copy()

        h, w = canvas.shape[:2]

        for idx, r in enumerate(regs):
            bbox = r.get("bbox", {})
            # 1) dört köşe varsa poligon
            if all(k in bbox for k in ("x1","y1","x2","y2","x3","y3","x4","y4")):
                pts = np.array([
                    [int(bbox["x1"]*sx), int(bbox["y1"]*sy)],
                    [int(bbox["x2"]*sx), int(bbox["y2"]*sy)],
                    [int(bbox["x3"]*sx), int(bbox["y3"]*sy)],
                    [int(bbox["x4"]*sx), int(bbox["y4"]*sy)]
                ], dtype=np.int32)
                cv2.polylines(canvas, [pts], isClosed=True, color=(0,255,0), thickness=thickness)
                # label pozisyonu: üst sol köşe
                lx, ly = pts[0][0], max(0, pts[0][1]-5)
            # 2) x,y,w,h varsa dikdörtgen
            elif all(k in bbox for k in ("x","y","width","height")):
                x = int(bbox["x"]*sx); y = int(bbox["y"]*sy)
                ww = int(bbox["width"]*sx); hh = int(bbox["height"]*sy)
                cv2.rectangle(canvas, (x,y), (x+ww, y+hh), (0,255,0), thickness)
                lx, ly = x, max(0, y-5)
            else:
                continue  # tanınmayan bbox

            if put_text:
                txt = r.get("text","")
                if len(txt) > max_label_len:
                    txt = txt[:max_label_len-1] + "…"
                # arka planı okunur yapmak için sınır
                cv2.putText(canvas, txt, (lx, ly),
                            cv2.FONT_HERSHEY_SIMPLEX, 0.45, (0,0,0), 3, cv2.LINE_AA)
                cv2.putText(canvas, txt, (lx, ly),
                            cv2.FONT_HERSHEY_SIMPLEX, 0.45, (255,255,255), 1, cv2.LINE_AA)

        out_imgs.append(canvas)

        if save_dir:
            cv2.imwrite(os.path.join(save_dir, f"page_{i}.png"), canvas)

        if show:
            plt.figure(figsize=(10,6))
            plt.axis("off")
            plt.imshow(cv2.cvtColor(canvas, cv2.COLOR_BGR2RGB))
            plt.title(f"Page {i}")
            plt.show()

    return out_imgs

# 1) Region olarak düzeltilmiş listeyi kullan (önerilir)
regions = paddle_ocr_regions_aligned  # veya paddle_ocr_regions

# 2) Çiz ve göster; PNG kaydetmek istersen save_dir ver
_ = draw_paddle_regions_on_images(
    images=final_lower_imgs,
    regions_pages=regions,
    scale=(1.0, 1.0),        # eğer OCR bbox'ları orijinal çözünürlükte ve resmi sonradan resize ettiysen burayı değiştir
    put_text=True,
    max_label_len=55,
    thickness=2,
    save_dir="debug_boxes",  # klasör oluşturup her sayfayı kaydeder
    show=True
)