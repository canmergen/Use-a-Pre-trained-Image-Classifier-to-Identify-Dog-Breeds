import pandas as pd
import numpy as np

def fill_missing_dates(df: pd.DataFrame, date_col: str = "tarih") -> pd.DataFrame:
    """
    Sadece tarih sütunu boş olan satırlarda:
    - Diğer tüm kolonlar (page_index dahil) aynıysa
    - Ve aynı satırın bir kopyasında tarih doluysa
    o tarihi buraya kopyalar.
    """
    if date_col not in df.columns:
        return df

    out = df.copy()

    # 1) Tarih için "boş" değer tanımı
    def is_missing(val) -> bool:
        if val is None or (isinstance(val, float) and np.isnan(val)):
            return True
        s = str(val).strip().lower()
        return s in ("", "nan", "none")

    # 2) Diğer tüm kolonlardan text key üret
    other_cols = [c for c in out.columns if c != date_col]
    # hepsini str'e çevirip birleştiriyoruz
    out["_key_"] = out[other_cols].astype(str).agg("||".join, axis=1)

    # 3) Her key için dolu tarihleri bul
    key_to_date = {}
    for key, grp in out.groupby("_key_"):
        vals = [v for v in grp[date_col].tolist() if not is_missing(v)]
        uniq = list({str(v).strip(): v for v in vals}.values())  # string bazında unique
        if len(uniq) == 1:
            key_to_date[key] = uniq[0]

    # 4) Boş tarihleri doldur
    def fill_val(row):
        val = row[date_col]
        if not is_missing(val):
            return val
        key = row["_key_"]
        return key_to_date.get(key, val)

    out[date_col] = out.apply(fill_val, axis=1)

    # 5) Son olarak NaN/boşları tekrar None yap
    def normalize_back(val):
        return None if is_missing(val) else val

    out[date_col] = out[date_col].apply(normalize_back)

    # yardımcı key'i at
    out = out.drop(columns=["_key_"])

    return out