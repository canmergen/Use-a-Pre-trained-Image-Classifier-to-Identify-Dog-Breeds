import cv2
import numpy as np

def return_binary_mask(
    table: np.ndarray,
    ver_kernels=(1, 250),
    hor_kernels=(250, 1),
    hor_erode_iter: int = 2,
    hor_dilate_iter: int = 20,
    ver_erode_iter: int = 1,
    ver_dilate_iter: int = 20,
    handle_inv: bool = True,
    # imza / blob temizliği için parametreler
    remove_blobs: bool = True,
    blob_min_area: int = 150,       # çok küçük gürültüyü dikkate alma
    blob_min_thickness: int = 5,    # min(kısa_kenar) bundan büyükse "kalın" say
    blob_max_aspect_ratio: float = 8.0  # max(w,h)/min(w,h) < bu ise line değildir
):
    """
    1) Tablo görselini binary-inv'e çevirir.
    2) İmza benzeri kalın, kompakt blobları siler (isteğe bağlı).
    3) Horizontal ve vertical line mask'leri üretir.
    4) Bu iki mask'i birleştirerek 'binary_lines' döndürür.

    Dönüş:
        binary_lines, binary_horizontal, binary_vertical
    """

    def add_borders(img: np.ndarray) -> np.ndarray:
        img = img.copy()
        img[0, :] = 255
        img[-1, :] = 255
        img[:, 0] = 255
        img[:, -1] = 255
        return img

    # 0) Griye çevir
    if table.ndim == 3:
        gray = cv2.cvtColor(table, cv2.COLOR_BGR2GRAY)
    else:
        gray = table.copy()

    # 1) Binary-inv: çizgiler / yazılar = 255, arka plan = 0
    _, binary = cv2.threshold(gray, 240, 255, cv2.THRESH_BINARY_INV)
    binary = add_borders(binary)

    # 2) İmza / kompakt blob temizliği
    if remove_blobs:
        # Connected components
        num_labels, labels, stats, _ = cv2.connectedComponentsWithStats(
            binary, connectivity=8
        )

        for label in range(1, num_labels):  # 0 = arka plan
            x, y, w, h, area = stats[label]

            # Çok küçük objeleri boş ver (zaten gürültü olabilir)
            if area < blob_min_area:
                continue

            short_side = min(w, h)
            long_side = max(w, h)
            aspect_ratio = long_side / max(1, short_side)

            # İnce uzun çizgiler: genelde short_side çok küçük, aspect_ratio büyük
            is_thin_line = (short_side <= blob_min_thickness) and (aspect_ratio >= blob_max_aspect_ratio)

            if is_thin_line:
                # Gerçek line; dokunma
                continue

            # Buraya düşenler: kalın ve kompakt bloblar (imza, text vb.)
            # Bunları siliyoruz (0'a çekiyoruz)
            binary[labels == label] = 0

    # 3) Horizontal / vertical line mask'leri
    kernel_hor = cv2.getStructuringElement(cv2.MORPH_RECT, hor_kernels)
    kernel_ver = cv2.getStructuringElement(cv2.MORPH_RECT, ver_kernels)

    # Horizontal
    binary_horizontal = cv2.erode(binary, kernel_hor, iterations=hor_erode_iter)
    binary_horizontal = cv2.dilate(binary_horizontal, kernel_hor, iterations=hor_dilate_iter)

    # Vertical
    binary_vertical = cv2.erode(binary, kernel_ver, iterations=ver_erode_iter)
    binary_vertical = cv2.dilate(binary_vertical, kernel_ver, iterations=ver_dilate_iter)

    # 4) Eğer sağdaki imza kolonunu komple ignore etmek istersen
    if handle_inv:
        inv_x_range = 0
        for x in range(binary_vertical.shape[1]):
            mean_y = np.mean(binary_vertical[:, x])
            if mean_y == 0:
                inv_x_range = x
                break

        if inv_x_range >= binary_vertical.shape[1] * 0.15:
            # Bu kısım senin mevcut mantığın; istersen burayı da ayrıca
            # imza kolonuna göre maskeleyecek şekilde oynayabilirsin.
            binary_vertical[:, 2 * inv_x_range:-2] = 0

    # 5) Horizontal + vertical birleşimi (line mask)
    binary_lines = cv2.addWeighted(binary_vertical, 0.5,
                                   binary_horizontal, 0.5, 0.0)

    return binary_lines, binary_horizontal, binary_vertical

binarized_tables = process_tables_with_line_fix(res)

for i, img in enumerate(binarized_tables):
    binary_lines, horiz, vert = return_binary_mask(img)
    plt.figure(figsize=(16, 4))
    plt.subplot(1, 3, 1); plt.title(f"lines {i}"); plt.imshow(binary_lines, cmap="gray"); plt.axis("off")
    plt.subplot(1, 3, 2); plt.title("horiz"); plt.imshow(horiz, cmap="gray"); plt.axis("off")
    plt.subplot(1, 3, 3); plt.title("vert");  plt.imshow(vert, cmap="gray");  plt.axis("off")
    plt.show()