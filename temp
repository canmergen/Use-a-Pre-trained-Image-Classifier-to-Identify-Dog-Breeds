from ultralytics import YOLO
import numpy as np
import cv2

def _to_rgb_uint8(img: np.ndarray) -> np.ndarray:
    """
    Normalize any OpenCV/NumPy image to uint8 RGB (H,W,3).
    Handles GRAY, BGR, BGRA, and float arrays.
    """
    if img is None:
        raise ValueError("Received None image.")
    arr = img

    # dtype normalize
    if arr.dtype != np.uint8:
        # assume 0..1 or arbitrary float; clip to 0..255
        arr = np.clip(arr, 0, 255)
        if arr.max() <= 1.0:
            arr = (arr * 255.0)
        arr = arr.astype(np.uint8)

    # shape normalize
    if arr.ndim == 2:  # GRAY
        arr = cv2.cvtColor(arr, cv2.COLOR_GRAY2RGB)
    elif arr.ndim == 3:
        c = arr.shape[2]
        if c == 1:
            arr = cv2.cvtColor(arr, cv2.COLOR_GRAY2RGB)
        elif c == 3:
            # OpenCV kaynaklı ise muhtemelen BGR; RGB'ye çevir
            arr = cv2.cvtColor(arr, cv2.COLOR_BGR2RGB)
        elif c == 4:
            arr = cv2.cvtColor(arr, cv2.COLOR_BGRA2RGB)
        else:
            raise ValueError(f"Unsupported channel count: {c}")
    else:
        raise ValueError(f"Unsupported ndim: {arr.ndim}")

    return np.ascontiguousarray(arr)

def predict_on_memory_images(final_lower_imgs, best_model_path, conf=0.25, imgsz=None):
    """
    - final_lower_imgs: np.ndarray veya list[np.ndarray] (OpenCV okuyup getirdiğin tipler)
    - best_model_path: .pt yolu
    Dönen:
      all_boxes: [ {image_index, orig_shape, boxes:[{xyxy:[x1,y1,x2,y2], conf, class_id}]} , ... ]
      results: Ultralytics Results listesi (görselleştirme için .plot() kullanılabilir)
    """
    model = YOLO(best_model_path)

    # Listeye normalize et
    imgs_in = [final_lower_imgs] if isinstance(final_lower_imgs, np.ndarray) else list(final_lower_imgs)

    # Orijinal şekilleri not et ve RGB'ye çevir
    orig_shapes = [im.shape for im in imgs_in]
    imgs_rgb = [_to_rgb_uint8(im) for im in imgs_in]

    # Tahmin (disk yazımı kapalı)
    results = model.predict(
        source=imgs_rgb,
        conf=conf,
        save=False,
        save_txt=False,
        verbose=False,
        imgsz=imgsz  # None bırakabilirsin; istersen 1280 gibi bir değer verebilirsin
    )

    # Çıktıları topla
    all_boxes = []
    for i, (r, oshp) in enumerate(zip(results, orig_shapes)):
        boxes = []
        if hasattr(r, "boxes") and r.boxes is not None and len(r.boxes) > 0:
            xyxy  = r.boxes.xyxy.cpu().numpy()        # (N,4)  [x1,y1,x2,y2]
            confs = r.boxes.conf.cpu().numpy()        # (N,)
            clsid = r.boxes.cls.cpu().numpy().astype(int)  # (N,)
            for b, c, cl in zip(xyxy, confs, clsid):
                x1, y1, x2, y2 = b.tolist()
                boxes.append({
                    "xyxy": [float(x1), float(y1), float(x2), float(y2)],
                    "conf": float(c),
                    "class_id": int(cl)
                })
        all_boxes.append({
            "image_index": i,
            "orig_shape": oshp,   # (H,W,3)
            "boxes": boxes
        })
    return all_boxes, results

# --- Kullanım örneği ---
# all_boxes, results = predict_on_memory_images(final_lower_imgs, "/home/athena/KYCops/TB_KYC_Ops/notebooks/shared/best.pt", conf=0.25)
# annotated_rgb = results[0].plot()  # RGB numpy; istersen cv2.cvtColor(annotated_rgb, cv2.COLOR_RGB2BGR) ile göster