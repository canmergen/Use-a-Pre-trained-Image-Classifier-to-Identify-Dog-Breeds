import cv2
import numpy as np
from typing import Tuple

def return_binary_mask(
    table: np.ndarray,
    ver_kernels: Tuple[int, int] = (1, 800),
    hor_kernels: Tuple[int, int] = (800, 1),
    hor_erode_iter: int = 2,
    ver_erode_iter: int = 1,
    handle_inv: bool = True,
):
    """
    Girdi
    -----
    table : np.ndarray
        BGR veya gri tablo görüntüsü.

    Çıktı
    -----
    binary_lines      : horiz + vert çizgilerin birleşik maskesi
    binary_horizontal : sadece yatay çizgiler
    binary_vertical   : sadece dikey çizgiler
    """

    def add_borders(img: np.ndarray, border: int = 2) -> np.ndarray:
        """Kenarları beyaza boyayarak çizgi tespitini stabilize eder."""
        img[:border, :] = 255
        img[-border:, :] = 255
        img[:, :border] = 255
        img[:, -border:] = 255
        return img

    # 1) Griye çevir
    if table.ndim == 3:
        gray = cv2.cvtColor(table, cv2.COLOR_BGR2GRAY)
    else:
        gray = table.copy()

    # 2) İnverse threshold – çizgi/yazıları beyaz (255) yap
    _, binary = cv2.threshold(gray, 240, 255, cv2.THRESH_BINARY_INV)

    # 3) İstersen tablo bounding'i için kontur bilgisi (şimdilik kullanılmıyor ama içeride dursun)
    contours, _ = cv2.findContours(binary.copy(),
                                   cv2.RETR_LIST,
                                   cv2.CHAIN_APPROX_SIMPLE)

    # 4) Kenarlara beyaz border ekle
    binary = add_borders(binary)

    H, W = binary.shape[:2]

    # 5) Morfoloji kernel'leri
    kernel_hor = cv2.getStructuringElement(cv2.MORPH_RECT, hor_kernels)
    kernel_ver = cv2.getStructuringElement(cv2.MORPH_RECT, ver_kernels)

    # 6) Yatay çizgiler
    binary_horizontal = cv2.erode(binary, kernel_hor, iterations=hor_erode_iter)
    binary_horizontal = cv2.dilate(binary_horizontal, kernel_hor, iterations=20)

    # 7) Dikey çizgiler
    binary_vertical = cv2.erode(binary, kernel_ver, iterations=ver_erode_iter)
    binary_vertical = cv2.dilate(binary_vertical, kernel_ver, iterations=20)

    # 8) Sağ taraftaki full siyah kolonları temizle (senin mevcut handle_inv mantığın)
    if handle_inv:
        inv_x_range = 0
        for x in range(binary_vertical.shape[1]):
            mean_y = np.mean(binary_vertical[:, x])
            if mean_y == 0:
                inv_x_range = x
                break

        if inv_x_range >= binary_vertical.shape[1] * 0.15:
            # 2*inv_x_range - 2 negatif olmasın diye max ile koruyorum
            binary_vertical[:, :max(0, 2 * inv_x_range - 2)] = 0

    # 9) Yatay + dikey çizgileri birleştir
    binary_lines = cv2.addWeighted(binary_vertical, 0.5,
                                   binary_horizontal, 0.5, 0.0)

    return binary_lines, binary_horizontal, binary_vertical

for i in range(len(binarized_tables)):
    binary_lines, horiz, vert = return_binary_mask(binarized_tables[i])
    plt.imshow(binary_lines, cmap="gray")
    plt.show()


def count_lines(binary_horizontal, binary_vertical, min_length=50):
    """
    Her yatay ve dikey çizgiyi connected component ile sayar.
    
    min_length:
        Çok kısa (gürültü) çizgileri saymamak için minimum genişlik/yükseklik.
    """

    def count_cc(mask, axis):
        """
        axis = 'h' → yatay çizgi
        axis = 'v' → dikey çizgi
        """
        num, labels, stats, _ = cv2.connectedComponentsWithStats(mask, connectivity=8)
        count = 0

        for i in range(1, num):  # 0: background
            x, y, w, h, area = stats[i]
            
            if axis == 'h':
                # yatay çizgi: genişlik uzun olur
                if w >= min_length and h < w * 0.2:
                    count += 1
            else:
                # dikey çizgi: yükseklik uzun olur
                if h >= min_length and w < h * 0.2:
                    count += 1
        
        return count

    horiz_count = count_cc(binary_horizontal, 'h')
    vert_count  = count_cc(binary_vertical, 'v')

    return horiz_count, vert_count

binary_lines, horiz, vert = return_binary_mask(table_img)

h_count, v_count = count_lines(horiz, vert)

print("Horizontal lines:", h_count)
print("Vertical lines:", v_count)