import pandas as pd
import numpy as np

def fill_missing_dates_simple(df: pd.DataFrame, date_col: str = "tarih") -> pd.DataFrame:
    """
    date_col sütununda eksik olan tarihleri doldurur.
    - Aynı satırdaki diğer tüm kolonlar birebir aynı ise grup kabul edilir.
    - Grup içinde tek bir geçerli tarih varsa, gruptaki eksik tarihler bu değerle doldurulur.
    - En sonda NaN değerler tekrar gerçek None yapılır (string 'None' değil).
    """
    out = df.copy()

    # 1) Tarih sütununu object yap; None/NaN karışık olabilir
    if date_col not in out.columns:
        return out

    out[date_col] = out[date_col].astype(object)

    # 2) Grup anahtarı: tarih haricindeki tüm kolonlar
    key_cols = [c for c in out.columns if c != date_col]

    # 3) Her grup içinde tarih doldurma
    for _, idx in out.groupby(key_cols, dropna=False).groups.items():
        idx = list(idx)
        vals = out.loc[idx, date_col]

        # Geçerli tarihleri filtrele
        valid = []
        for v in vals:
            if v is None:
                continue
            s = str(v).strip().lower()
            if s in ("", "nan", "none"):
                continue
            valid.append(v)

        uniq = pd.unique(valid)

        # Tek bir tarih varsa doldur
        if len(uniq) == 1:
            fill_val = uniq[0]
            mask_missing = vals.isna() | vals.astype(str).str.strip().str.lower().isin(["", "nan", "none"])
            out.loc[idx, date_col] = np.where(mask_missing, fill_val, vals)

    # 4) Tüm NaN'leri tekrar gerçek None'a çevir
    def _to_none(x):
        if x is None:
            return None
        if pd.isna(x):
            return None
        s = str(x).strip().lower()
        if s in ("nan", "none", ""):
            return None
        return x

    out[date_col] = out[date_col].apply(_to_none).astype(object)

    return out

