import numpy as np
import pandas as pd
from difflib import SequenceMatcher

def add_signature_flags_all_pages(
    table_dfs,
    page_cells_all,
    sig_boxes,
    signature_header_target="IMZA",   # veya "İMZA"
    iou_threshold=0.05,
    fuzzy_min_score=0.7,
):
    """
    table_dfs          : list[pd.DataFrame]  -> her sayfanın tablosu
    page_cells_all     : list[list[dict]]    -> her sayfa için hücreler
                         her hücre: {'page':p,'row':r,'col':c,'x':..,'y':..,'w':..,'h':..}
    sig_boxes          : YOLO imza çıktısı listesi
                         her eleman: {'image_index':p,'boxes':[{'xyxy':[x1,y1,x2,y2],...},...]}
    signature_header_target : 'IMZA' başlığını fuzzy ile bulmak için hedef string
    """

    # 1) Sig kutularını normalize et
    norm_sigs = []
    for sb in sig_boxes:
        img_idx = sb.get("image_index", 0)
        for b in sb.get("boxes", []):
            xyxy = b.get("xyxy") or b.get("bbox") or b
            x1, y1, x2, y2 = map(float, xyxy)
            norm_sigs.append(
                {
                    "image_index": img_idx,
                    "x_min": x1,
                    "y_min": y1,
                    "x_max": x2,
                    "y_max": y2,
                }
            )

    def iou_cell_sig(cell, sig):
        xA = max(cell["x"], sig["x_min"])
        yA = max(cell["y"], sig["y_min"])
        xB = min(cell["x"] + cell["w"], sig["x_max"])
        yB = min(cell["y"] + cell["h"], sig["y_max"])

        inter_w = max(0.0, xB - xA)
        inter_h = max(0.0, yB - yA)
        inter = inter_w * inter_h
        if inter <= 0:
            return 0.0

        area_cell = float(cell["w"] * cell["h"])
        area_sig = float((sig["x_max"] - sig["x_min"]) * (sig["y_max"] - sig["y_min"]))
        return inter / (area_cell + area_sig - inter)

    def fuzzy_best_col(columns, target):
        best_col = None
        best_score = 0.0
        t = target.upper()
        for col in columns:
            s = SequenceMatcher(None, str(col).upper(), t).ratio()
            if s > best_score:
                best_score = s
                best_col = col
        return best_col, best_score

    # 2) Sayfa bazlı imza flag yaz
    result_dfs = []

    for page_index, df in enumerate(table_dfs):
        if df is None or df.empty:
            result_dfs.append(df)
            continue

        # imza_flag kolonunu ekle (varsa dokunma)
        if "imza_flag" not in df.columns:
            df["imza_flag"] = 0

        # page_index kolonu varsa, değerleri sabit; ama burada kullanmamıza gerek yok
        data_cols = [c for c in df.columns if c != "page_index" and c != "imza_flag"]
        if not data_cols:
            result_dfs.append(df)
            continue

        # İMZA kolonunu fuzzy ile bul
        sig_col_name, score = fuzzy_best_col(data_cols, signature_header_target)
        if sig_col_name is None or score < fuzzy_min_score:
            # İmza kolonu bulunamadı → direkt geç
            result_dfs.append(df)
            continue

        sig_col_pos = data_cols.index(sig_col_name)

        # Bu sayfanın hücreleri ve imza kutuları
        cells = page_cells_all[page_index]
        page_sigs = [s for s in norm_sigs if s["image_index"] == page_index]

        if not cells or not page_sigs:
            result_dfs.append(df)
            continue

        # Her imza kutusunu ilgili hücrelerle eşleştir
        for sig in page_sigs:
            for cell in cells:
                if cell["col"] != sig_col_pos:
                    continue
                ov = iou_cell_sig(cell, sig)
                if ov > iou_threshold:
                    row_idx = cell["row"]
                    # df'in indeksinin satır sırası ile aynı olduğunu varsayıyoruz
                    if row_idx in df.index:
                        df.at[row_idx, "imza_flag"] = 1

        result_dfs.append(df)

    return result_dfs

# table_df_list: build_tables_from_pages çıkışı (sayfa bazlı df listesi)
table_df_with_flags = add_signature_flags_all_pages(
    table_dfs=table_df,
    page_cells_all=page_cells_all,
    sig_boxes=sig_boxes,
    signature_header_target="İMZA",   # başlıkta nasıl yazıyorsa ona göre
    iou_threshold=0.05,
    fuzzy_min_score=0.7,
)

for df in table_df_with_flags:
    display(df)