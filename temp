import cv2
import numpy as np

def binarize_and_enhance_table(table_img: np.ndarray,
                               auto_percentile: int = 90,
                               line_scale: int = 25) -> np.ndarray:
    """
    1) Tabloyu güvenli bir şekilde binarize eder.
    2) Yatay ve dikey çizgileri morfoloji ile güçlendirir, kopuklukları birleştirir.

    line_scale: çizgi uzunluğuna göre kernel boyutunu belirler.
                Daha küçük -> daha agresif çizgi yakalama.
    """

    # --- Griye çevir ---
    if table_img.ndim == 3:
        gray = cv2.cvtColor(table_img, cv2.COLOR_BGR2GRAY)
    else:
        gray = table_img.copy()

    # --- Kontrastı normalize et (aşırı uçları kırp) ---
    gmin, gmax = np.percentile(gray, [100-auto_percentile, auto_percentile])
    if gmax - gmin < 1e-6:
        norm = gray.astype(np.uint8)
    else:
        norm = np.clip((gray - gmin) * 255.0 / (gmax - gmin), 0, 255).astype(np.uint8)

    # --- Otsu ile binarizasyon (arka plan beyaz, içerik siyah) ---
    blur = cv2.GaussianBlur(norm, (3, 3), 0)
    _, bin_img = cv2.threshold(blur, 0, 255,
                               cv2.THRESH_BINARY + cv2.THRESH_OTSU)

    # --- Çizgi güçlendirme için içerik maskesini ters çevir (siyah->0, çizgi/yazı->255) ---
    inv = cv2.bitwise_not(bin_img)

    h, w = inv.shape[:2]

    # Kernel boyutlarını dinamik belirle
    horiz_k = max(10, w // line_scale)
    vert_k  = max(10, h // line_scale)

    horiz_kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (horiz_k, 1))
    vert_kernel  = cv2.getStructuringElement(cv2.MORPH_RECT, (1, vert_k))

    # --- Yatay ve dikey çizgileri doldur/güçlendir ---
    horiz_lines = cv2.morphologyEx(inv, cv2.MORPH_CLOSE, horiz_kernel, iterations=1)
    vert_lines  = cv2.morphologyEx(inv, cv2.MORPH_CLOSE, vert_kernel, iterations=1)

    # Çizgileri birleştir
    lines = cv2.max(horiz_lines, vert_lines)

    # Çizgileri orijinal içerik ile birleştir (yazıları kaybetmemek için)
    merged_inv = cv2.max(inv, lines)

    # Geri çevir (arka plan beyaz kalsın)
    enhanced = cv2.bitwise_not(merged_inv)

    return enhanced

def tight_table_crop(img: np.ndarray, margin: int = 5):
    if img.ndim == 3:
        gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    else:
        gray = img.copy()

    _, bin_img = cv2.threshold(gray, 0, 255,
                               cv2.THRESH_BINARY + cv2.THRESH_OTSU)
    non_white = cv2.bitwise_not(bin_img)
    coords = cv2.findNonZero(non_white)

    if coords is None:
        h, w = gray.shape[:2]
        return img, (0, 0, w, h)

    x, y, w, h = cv2.boundingRect(coords)
    x = max(0, x - margin)
    y = max(0, y - margin)
    x2 = min(img.shape[1], x + w + margin)
    y2 = min(img.shape[0], y + h + margin)

    cropped = img[y:y2, x:x2].copy()
    return cropped, (x, y, x2 - x, y2 - y)


def process_all_tables(res):
    binarized_tables = []
    for r in res:
        table = r.get("table_bw") or r.get("table")
        if table is None:
            continue

        try:
            # 1) Tabloyu sıkı kırp
            table_cropped, _ = tight_table_crop(table)

            # 2) Binarize + çizgi güçlendirme
            table_bin = binarize_and_enhance_table(
                table_cropped,
                auto_percentile=90,
                line_scale=25,   # istersen 20–30 arasıyla oynayabilirsin
            )

            binarized_tables.append(table_bin)
        except Exception as e:
            print(f"Sayfa {r.get('image_index')} hata: {e}")
            continue

    return binarized_tables

binarized_tables = process_all_tables(res)

for i, img in enumerate(binarized_tables):
    plt.figure(figsize=(8, 4))
    plt.title(f"Table {i}")
    plt.imshow(img, cmap="gray")  # artık tek kanal
    plt.axis("off")
    plt.show()